{% extends "base.html" %}

{% block title %}Webhook Settings - @{{ handle }}{% endblock %}

{% block content %}
<div id="root">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><a href="/" class="handle-link">@{{ handle }}</a> - Webhook Settings</h1>
            <div class="header-actions">
                <a href="/" class="nav-button" aria-label="Back to status" title="Back to status">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </a>
            </div>
        </header>

        <!-- Webhook Configuration -->
        <div class="webhook-section">
            <h2>Slack Integration via Webhooks</h2>
            <p class="webhook-description">
                Configure a webhook to receive real-time notifications when your status changes. 
                This is perfect for integrating with Slack, Discord, or custom automation systems.
            </p>

            {% if let Some(config) = webhook_config %}
            <!-- Existing Configuration -->
            <div class="webhook-config">
                <div class="config-item">
                    <label>Webhook URL</label>
                    <div class="url-display">
                        <code>{{ config.webhook_url }}</code>
                        <button type="button" class="copy-btn" data-copy="{{ config.webhook_url }}">Copy</button>
                    </div>
                </div>
                
                <div class="config-item">
                    <label>Webhook Secret</label>
                    <div class="secret-display">
                        <code class="secret-value" id="secret-value">{{ config.webhook_secret }}</code>
                        <button type="button" class="toggle-secret" id="toggle-secret">Show</button>
                        <button type="button" class="copy-btn" data-copy="{{ config.webhook_secret }}">Copy</button>
                    </div>
                </div>
                
                <div class="config-item">
                    <label>Status</label>
                    <div class="status-display">
                        <span class="status-indicator {% if config.enabled %}enabled{% else %}disabled{% endif %}">
                            {% if config.enabled %}Enabled{% else %}Disabled{% endif %}
                        </span>
                        {% if config.last_delivery_at.is_some() %}
                        <span class="last-delivery">
                            Last delivery: <span class="local-time" data-timestamp="{{ config.last_delivery_at.unwrap() }}" data-format="relative"></span>
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="config-actions">
                    <button type="button" class="test-btn" id="test-webhook">Test Webhook</button>
                    <button type="button" class="edit-btn" id="edit-webhook">Edit</button>
                    <button type="button" class="delete-btn" id="delete-webhook">Delete</button>
                </div>
            </div>
            
            <div class="webhook-deliveries">
                <h3>Recent Deliveries</h3>
                <div class="deliveries-list" id="deliveries-list">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            {% else %}
            <!-- Configuration Form -->
            <div class="webhook-form" id="webhook-form">
                <form id="webhook-config-form">
                    <div class="form-group">
                        <label for="webhook-url">Webhook URL</label>
                        <input type="url" id="webhook-url" name="webhook_url" 
                               placeholder="https://your-server.com/webhook" 
                               required>
                        <small>Must use HTTPS. This URL will receive POST requests when your status changes.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="webhook-secret">Secret (optional)</label>
                        <input type="text" id="webhook-secret" name="webhook_secret" 
                               placeholder="Leave empty to auto-generate">
                        <small>Used to sign webhook requests. If empty, we'll generate a secure secret for you.</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="save-btn">Save Webhook</button>
                        <button type="button" class="cancel-btn" onclick="window.location.href='/'">Cancel</button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
        
        <!-- Edit Form (initially hidden) -->
        <div class="webhook-edit-form hidden" id="webhook-edit-form">
            <h3>Edit Webhook Configuration</h3>
            <form id="webhook-edit-config-form">
                <div class="form-group">
                    <label for="edit-webhook-url">Webhook URL</label>
                    <input type="url" id="edit-webhook-url" name="webhook_url" 
                           value="{% if let Some(config) = webhook_config %}{{ config.webhook_url }}{% endif %}" 
                           required>
                </div>
                
                <div class="form-group">
                    <label for="edit-webhook-secret">Secret</label>
                    <input type="text" id="edit-webhook-secret" name="webhook_secret" 
                           value="{% if let Some(config) = webhook_config %}{{ config.webhook_secret }}{% endif %}" 
                           placeholder="Leave empty to generate new secret">
                    <small>Changing this will invalidate the current secret.</small>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="save-btn">Update Webhook</button>
                    <button type="button" class="cancel-btn" id="cancel-edit">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Documentation -->
        <div class="webhook-docs">
            <h3>Webhook Documentation</h3>
            
            <div class="doc-section">
                <h4>Event Types</h4>
                <ul>
                    <li><code>status.set</code> - When a new status is created or updated</li>
                    <li><code>status.cleared</code> - When a status is deleted or cleared</li>
                </ul>
            </div>
            
            <div class="doc-section">
                <h4>Payload Example</h4>
                <pre><code>{
  "type": "status.set",
  "user_did": "did:plc:example...",
  "handle": "alice.bsky.social",
  "emoji": "ðŸš€",
  "text": "Working on something cool",
  "expires_at": "2025-01-10T15:30:00Z",
  "status_uri": "at://did:plc:.../io.zzstoatzz.status.record/abc123",
  "timestamp": "2025-01-10T14:30:00Z",
  "event_id": "uuid-here",
  "schema": "status-webhook.v1"
}</code></pre>
            </div>
            
            <div class="doc-section">
                <h4>Security</h4>
                <p>All webhook requests include these headers for verification:</p>
                <ul>
                    <li><code>X-Status-Timestamp</code> - Unix timestamp when request was sent</li>
                    <li><code>X-Status-Event-Id</code> - Unique ID for this event (use for idempotency)</li>
                    <li><code>X-Status-Signature</code> - HMAC-SHA256 signature: <code>v1=hex(hmac_sha256(secret, "v0:{timestamp}:{body}"))</code></li>
                    <li><code>Idempotency-Key</code> - Same as Event ID</li>
                </ul>
            </div>
            
            <div class="doc-section">
                <h4>Sample Handler (Node.js)</h4>
                <pre><code>const crypto = require('crypto');

app.post('/webhook', (req, res) => {
  const signature = req.headers['x-status-signature'];
  const timestamp = req.headers['x-status-timestamp'];
  const body = JSON.stringify(req.body);
  
  // Verify signature
  const expectedSig = `v1=${crypto
    .createHmac('sha256', process.env.WEBHOOK_SECRET)
    .update(`v0:${timestamp}:${body}`)
    .digest('hex')}`;
    
  if (signature !== expectedSig) {
    return res.status(401).send('Invalid signature');
  }
  
  // Check timestamp (reject old requests)
  if (Math.abs(Date.now() / 1000 - parseInt(timestamp)) > 300) {
    return res.status(401).send('Request too old');
  }
  
  // Process the event
  console.log('Status event:', req.body);
  res.status(200).send('OK');
});</code></pre>
            </div>
        </div>
    </div>
</div>

<style>
.webhook-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 2rem;
    margin-bottom: 2rem;
}

.webhook-description {
    color: var(--text-secondary);
    margin-bottom: 2rem;
    line-height: 1.6;
}

.webhook-config {
    margin-bottom: 2rem;
}

.config-item {
    margin-bottom: 1.5rem;
}

.config-item label {
    display: block;
    color: var(--text-secondary);
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.url-display, .secret-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.url-display code, .secret-display code {
    flex: 1;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 0.5rem 0.75rem;
    font-family: monospace;
    color: var(--text-primary);
    overflow-wrap: break-word;
    word-break: break-all;
}

.secret-value.hidden {
    filter: blur(4px);
    user-select: none;
}

.copy-btn, .toggle-secret {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
}

.copy-btn:hover, .toggle-secret:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}

.status-display {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.status-indicator {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    font-weight: 500;
}

.status-indicator.enabled {
    background: rgba(34, 197, 94, 0.1);
    color: rgb(34, 197, 94);
}

.status-indicator.disabled {
    background: rgba(239, 68, 68, 0.1);
    color: rgb(239, 68, 68);
}

.last-delivery {
    color: var(--text-tertiary);
    font-size: 0.875rem;
}

.config-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 2rem;
}

.test-btn, .edit-btn, .delete-btn {
    padding: 0.5rem 1rem;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
}

.test-btn {
    background: var(--accent);
    color: white;
    border: none;
}

.test-btn:hover {
    background: var(--accent-hover);
}

.edit-btn {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

.edit-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
}

.delete-btn {
    background: transparent;
    border: 1px solid var(--danger);
    color: var(--danger);
}

.delete-btn:hover {
    background: var(--danger);
    color: white;
}

.webhook-form, .webhook-edit-form {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.webhook-edit-form.hidden {
    display: none;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    color: var(--text-primary);
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-group input {
    width: 100%;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 1rem;
}

.form-group input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
}

.form-group small {
    display: block;
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.form-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 2rem;
}

.save-btn, .cancel-btn {
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
}

.save-btn {
    background: var(--accent);
    color: white;
    border: none;
}

.save-btn:hover {
    background: var(--accent-hover);
}

.cancel-btn {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
}

.cancel-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
}

.webhook-deliveries {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
}

.webhook-deliveries h3 {
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.delivery-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    margin-bottom: 0.5rem;
}

.delivery-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.delivery-event {
    font-weight: 500;
    color: var(--text-primary);
}

.delivery-time {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.delivery-status {
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 500;
}

.delivery-status.success {
    background: rgba(34, 197, 94, 0.1);
    color: rgb(34, 197, 94);
}

.delivery-status.failed {
    background: rgba(239, 68, 68, 0.1);
    color: rgb(239, 68, 68);
}

.webhook-docs {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 2rem;
}

.webhook-docs h3 {
    margin-bottom: 1.5rem;
    color: var(--text-primary);
}

.doc-section {
    margin-bottom: 2rem;
}

.doc-section h4 {
    margin-bottom: 1rem;
    color: var(--text-primary);
    font-size: 1.1rem;
}

.doc-section ul {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
}

.doc-section li {
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
}

.doc-section code {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.875rem;
}

.doc-section pre {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 1rem;
    overflow-x: auto;
    margin: 1rem 0;
}

.doc-section pre code {
    background: none;
    border: none;
    padding: 0;
    font-size: 0.875rem;
    line-height: 1.4;
}

/* Mobile adjustments */
@media (max-width: 640px) {
    .config-actions, .form-actions {
        flex-direction: column;
    }
    
    .url-display, .secret-display {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
    }
    
    .delivery-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
}

.hidden {
    display: none !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // Copy to clipboard functionality
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const text = btn.getAttribute('data-copy');
            try {
                await navigator.clipboard.writeText(text);
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        });
    });

    // Toggle secret visibility
    const toggleSecret = document.getElementById('toggle-secret');
    const secretValue = document.getElementById('secret-value');
    if (toggleSecret && secretValue) {
        secretValue.classList.add('hidden');
        toggleSecret.addEventListener('click', () => {
            secretValue.classList.toggle('hidden');
            toggleSecret.textContent = secretValue.classList.contains('hidden') ? 'Show' : 'Hide';
        });
    }

    // Load webhook deliveries if webhook exists
    {% if webhook_config.is_some() %}
    loadWebhookDeliveries();
    {% endif %}

    // Test webhook functionality
    const testBtn = document.getElementById('test-webhook');
    if (testBtn) {
        testBtn.addEventListener('click', async () => {
            testBtn.disabled = true;
            testBtn.textContent = 'Testing...';
            
            const webhookUrl = '{{ webhook_config.as_ref().map(|c| c.webhook_url.clone()).unwrap_or_default() }}';
            const webhookSecret = '{{ webhook_config.as_ref().map(|c| c.webhook_secret.clone()).unwrap_or_default() }}';
            
            try {
                const response = await fetch('/api/webhook/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        webhook_url: webhookUrl,
                        webhook_secret: webhookSecret
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Test successful! Status: ${result.status_code}`);
                    loadWebhookDeliveries(); // Refresh delivery list
                } else {
                    alert(`Test failed: ${result.error}`);
                }
            } catch (err) {
                alert(`Test failed: ${err.message}`);
            }
            
            testBtn.disabled = false;
            testBtn.textContent = 'Test Webhook';
        });
    }

    // Edit webhook functionality
    const editBtn = document.getElementById('edit-webhook');
    const editForm = document.getElementById('webhook-edit-form');
    const cancelEditBtn = document.getElementById('cancel-edit');
    
    if (editBtn && editForm) {
        editBtn.addEventListener('click', () => {
            editForm.classList.remove('hidden');
        });
    }
    
    if (cancelEditBtn && editForm) {
        cancelEditBtn.addEventListener('click', () => {
            editForm.classList.add('hidden');
        });
    }

    // Delete webhook functionality
    const deleteBtn = document.getElementById('delete-webhook');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this webhook configuration? This cannot be undone.')) {
                try {
                    const response = await fetch('/api/webhook/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.location.reload(); // Refresh page to show form
                    } else {
                        alert('Failed to delete webhook configuration');
                    }
                } catch (err) {
                    alert(`Failed to delete: ${err.message}`);
                }
            }
        });
    }

    // Form submissions
    const configForm = document.getElementById('webhook-config-form');
    const editConfigForm = document.getElementById('webhook-edit-config-form');
    
    if (configForm) {
        configForm.addEventListener('submit', handleWebhookSubmit);
    }
    
    if (editConfigForm) {
        editConfigForm.addEventListener('submit', handleWebhookSubmit);
    }

    async function handleWebhookSubmit(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {
            webhook_url: formData.get('webhook_url'),
            webhook_secret: formData.get('webhook_secret') || undefined
        };
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';
        
        try {
            const response = await fetch('/api/webhook/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                window.location.reload(); // Refresh to show the saved config
            } else {
                alert(`Failed to save: ${result.error}`);
            }
        } catch (err) {
            alert(`Failed to save: ${err.message}`);
        }
        
        submitBtn.disabled = false;
        submitBtn.textContent = e.target.id === 'webhook-edit-config-form' ? 'Update Webhook' : 'Save Webhook';
    }

    async function loadWebhookDeliveries() {
        try {
            const response = await fetch('/api/webhook/deliveries');
            const deliveries = await response.json();
            
            const deliveriesList = document.getElementById('deliveries-list');
            if (!deliveriesList) return;
            
            if (deliveries.length === 0) {
                deliveriesList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No deliveries yet</p>';
                return;
            }
            
            deliveriesList.innerHTML = deliveries.map(delivery => {
                const timestamp = new Date(delivery.delivered_at * 1000).toLocaleString();
                const statusClass = delivery.success ? 'success' : 'failed';
                const statusText = delivery.success ? 'Success' : 'Failed';
                
                return `
                    <div class="delivery-item">
                        <div class="delivery-info">
                            <div class="delivery-event">${delivery.event_type}</div>
                            <div class="delivery-time">${timestamp}</div>
                        </div>
                        <div class="delivery-status ${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');
        } catch (err) {
            console.error('Failed to load deliveries:', err);
        }
    }
});
</script>
{% endblock content %}