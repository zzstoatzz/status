{% extends "base.html" %}

{% block content %}
<div id="root">
    <div class="error"></div>
    <div id="header">
        {% if let Some(Profile {did, display_name}) = profile %}
            {% if let Some(name) = display_name %}
            <h1>{{name}}'s status</h1>
            {% else %}
            <h1>your status</h1>
            {% endif %}
            <p>what are you up to right now?</p>
        {% else %}
            <h1>status tracker</h1>
            <p>share what you're up to</p>
        {% endif %}
    </div>
    <div class="container">
        <div class="card">
            {% if let Some(Profile {did, display_name}) = profile %}
            <form action="/logout" method="get" class="session-form">
                <div>
                    Hi,
                    {% if let Some(display_name) = display_name %}
                    <strong>{{display_name}}</strong>
                    {% else %}
                    <strong>friend</strong>
                    {% endif %}. What's
                    your status today??
                </div>
                <div>
                    <button type="submit">Log out</button>
                </div>
            </form>
            {% else %}
            <div class="session-form">
                <div><a href="/login">Log in</a> to set your status!</div>
                <div>
                    <a href="/login" class="button">Log in</a>
                </div>
            </div>
            {% endif %}


        </div>
        {% if let Some(Profile {did, display_name}) = profile %}
        <!-- Walkthrough Elements -->
        <div class="walkthrough-overlay"></div>
        <div class="walkthrough-spotlight"></div>
        <div class="walkthrough-tooltip">
            <div class="walkthrough-progress"></div>
            <h3 id="walkthrough-title"></h3>
            <p id="walkthrough-text"></p>
            <div class="walkthrough-actions">
                <button class="walkthrough-skip">Skip</button>
                <button class="walkthrough-next">Next</button>
            </div>
        </div>
        
        <div class="status-form-container">
            <h3>set your status</h3>
            <div class="current-status-info">
                {% if let Some(my_status) = my_status %}
                <p>current: <span class="current-emoji">{{my_status}}</span> 
                {% for status in statuses %}
                    {% if status.author_did == did.to_string() && loop.first %}
                        {% if status.text.is_some() %}
                        - {{ status.text.as_ref().unwrap() }}
                        {% endif %}
                        {% if status.expires_at.is_some() && !status.is_expired() %}
                        (<span class="local-time" data-timestamp="{{ status.expires_at.as_ref().unwrap().to_rfc3339() }}" data-prefix="expires"></span>)
                        {% endif %}
                    {% endif %}
                {% endfor %}
                </p>
                {% else %}
                <p>no status set</p>
                {% endif %}
            </div>
            
            <form action="/status" method="post" class="status-form" id="status-form">
                <div class="emoji-selector">
                    <label>emoji:</label>
                    <div class="emoji-grid">
                        {% for emoji in status_options %}
                        <label class="emoji-option">
                            <input type="radio" name="status" value="{{emoji}}" required
                                   data-emoji="{{emoji}}"
                                   {% if let Some(my_status) = my_status %}{%if my_status == emoji %}checked{% endif %}{% endif %}>
                            <span class="emoji-display">{{emoji}}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="text-input">
                    <label for="status_text">description (optional):</label>
                    <input type="text" id="status_text" name="text" 
                           placeholder="what are you up to?" 
                           maxlength="100"
                           value="">
                </div>
                
                <div class="expiration-selector">
                    <label for="expires_in">expires in:</label>
                    <select id="expires_in" name="expires_in">
                        <option value="">never</option>
                        <option value="30m">30 minutes</option>
                        <option value="1h" selected>1 hour</option>
                        <option value="2h">2 hours</option>
                        <option value="4h">4 hours</option>
                        <option value="8h">8 hours</option>
                        <option value="1d">1 day</option>
                        <option value="1w">1 week</option>
                    </select>
                </div>
                
                <div class="form-message" id="form-message"></div>
                <button type="submit" class="submit-button" id="submit-btn">update status</button>
            </form>
        </div>
        
        <script>
            // Store current status for comparison
            const currentStatus = {
                emoji: {% if let Some(my_status) = my_status %}"{{my_status}}"{% else %}null{% endif %},
                text: {% for status in statuses %}{% if status.author_did == did.to_string() && loop.first %}{% if status.text.is_some() %}"{{ status.text.as_ref().unwrap() }}"{% else %}""{% endif %}{% endif %}{% endfor %} || "",
                expires_in: "" // We don't track the original expiration
            };
            
            const form = document.getElementById('status-form');
            const message = document.getElementById('form-message');
            const submitBtn = document.getElementById('submit-btn');
            const textInput = document.getElementById('status_text');
            const expiresSelect = document.getElementById('expires_in');
            
            function checkForChanges() {
                const selectedEmoji = document.querySelector('input[name="status"]:checked');
                
                if (!selectedEmoji) {
                    message.textContent = '';
                    submitBtn.disabled = false;
                    return;
                }
                
                const newEmoji = selectedEmoji.value;
                const newText = textInput.value.trim();
                
                // Check if this is identical to current status (ignoring expiration)
                if (currentStatus.emoji === newEmoji && currentStatus.text === newText) {
                    message.textContent = 'This is already your current status. Change the emoji or text to update.';
                    message.className = 'form-message error';
                    submitBtn.disabled = true;
                } else {
                    message.textContent = '';
                    message.className = 'form-message';
                    submitBtn.disabled = false;
                }
            }
            
            // Check on any change
            document.querySelectorAll('input[name="status"]').forEach(radio => {
                radio.addEventListener('change', checkForChanges);
            });
            textInput.addEventListener('input', checkForChanges);
            
            // Initial check
            checkForChanges();
        </script>
        {% endif %}
        {% for status in statuses %}
        <div class="{% if loop.first %} status-line no-line {% else %} status-line {% endif %} ">
            <div>
                <div class="status">{{status.status}}</div>
            </div>
            <div class="desc">
                <a class="author"
                   href="https://bsky.app/profile/{{status.author_did}}">{{status.author_display_name()}}</a>
                {% if status.text.is_some() %}
                - {{ status.text.as_ref().unwrap() }}
                {% endif %}
                <div class="timestamp">
                    <span class="local-time" data-timestamp="{{ status.started_at.to_rfc3339() }}" data-format="relative" data-prefix="started"></span>
                    {% if status.expires_at.is_some() %}
                        {% if !status.is_expired() %}
                        Â· <span class="local-time" data-timestamp="{{ status.expires_at.as_ref().unwrap().to_rfc3339() }}" data-prefix="expires"></span>
                        {% else %}
                        Â· expired
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Format local times
const formatLocalTime = () => {
    document.querySelectorAll('.local-time').forEach(el => {
        const timestamp = el.getAttribute('data-timestamp');
        const format = el.getAttribute('data-format');
        const prefix = el.getAttribute('data-prefix');
        
        if (!timestamp) return;
        
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        let text = '';
        
        if (format === 'relative' || prefix === 'started') {
            if (diffMins < 1) {
                text = prefix === 'started' ? 'started just now' : 'just now';
            } else if (diffMins < 60) {
                const ago = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                text = prefix === 'started' ? `started ${ago}` : ago;
            } else if (diffHours < 24) {
                const ago = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                text = prefix === 'started' ? `started ${ago}` : ago;
            } else if (diffDays < 7) {
                const ago = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
                text = prefix === 'started' ? `started ${ago}` : ago;
            } else {
                text = prefix === 'started' ? `started ${date.toLocaleDateString()}` : date.toLocaleDateString();
            }
        } else if (prefix === 'expires') {
            const futureMs = date - now;
            const futureMins = Math.floor(futureMs / 60000);
            const futureHours = Math.floor(futureMs / 3600000);
            const futureDays = Math.floor(futureMs / 86400000);
            
            if (futureMins < 1) {
                text = 'expires soon';
            } else if (futureMins < 60) {
                text = `expires in ${futureMins} minute${futureMins !== 1 ? 's' : ''}`;
            } else if (futureHours < 24) {
                text = `expires in ${futureHours} hour${futureHours !== 1 ? 's' : ''}`;
            } else {
                text = `expires in ${futureDays} day${futureDays !== 1 ? 's' : ''}`;
            }
        } else {
            // Default format
            const options = { 
                month: 'short', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            text = date.toLocaleString('en-US', options).toLowerCase();
        }
        
        el.textContent = text;
    });
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    formatLocalTime();
    
    // Update times every minute
    setInterval(formatLocalTime, 60000);
    
    // Initialize walkthrough for logged-in users
    {% if let Some(Profile {did, display_name}) = profile %}
    initWalkthrough();
    {% endif %}
});

// Walkthrough functionality
function initWalkthrough() {
    // Check if user has seen the walkthrough
    if (localStorage.getItem('walkthrough_completed') === 'true') {
        return;
    }
    
    const overlay = document.querySelector('.walkthrough-overlay');
    const spotlight = document.querySelector('.walkthrough-spotlight');
    const tooltip = document.querySelector('.walkthrough-tooltip');
    const titleEl = document.getElementById('walkthrough-title');
    const textEl = document.getElementById('walkthrough-text');
    const progressEl = document.querySelector('.walkthrough-progress');
    const nextBtn = document.querySelector('.walkthrough-next');
    const skipBtn = document.querySelector('.walkthrough-skip');
    
    const steps = [
        {
            title: 'Welcome to Status Tracker! ðŸ‘‹',
            text: 'Share what you\'re up to with a simple emoji and optional text. Let\'s take a quick tour!',
            element: null,
            position: 'center'
        },
        {
            title: 'Pick Your Emoji',
            text: 'Choose any emoji to represent your current status. Click on one to select it!',
            element: '.emoji-grid',
            position: 'bottom'
        },
        {
            title: 'Add Context (Optional)',
            text: 'Want to add more detail? Type a short description of what you\'re doing.',
            element: '#status_text',
            position: 'bottom'
        },
        {
            title: 'Set Expiration Time',
            text: 'Your status can expire automatically. Choose how long it should last.',
            element: '#expires_in',
            position: 'bottom'
        },
        {
            title: 'You\'re All Set! ðŸŽ‰',
            text: 'Click "update status" to share what you\'re up to. Your status will appear below and others can see it at your public URL.',
            element: '#submit-btn',
            position: 'top'
        }
    ];
    
    let currentStep = 0;
    
    function showStep(step) {
        // Update progress dots
        progressEl.innerHTML = steps.map((_, i) => 
            `<div class="walkthrough-dot ${i === step ? 'active' : ''}"></div>`
        ).join('');
        
        // Update content
        titleEl.textContent = steps[step].title;
        textEl.textContent = steps[step].text;
        
        // Update button text
        nextBtn.textContent = step === steps.length - 1 ? 'Got it!' : 'Next';
        
        // Position spotlight and tooltip
        if (steps[step].element) {
            const el = document.querySelector(steps[step].element);
            if (el) {
                const rect = el.getBoundingClientRect();
                spotlight.style.left = `${rect.left - 10}px`;
                spotlight.style.top = `${rect.top - 10}px`;
                spotlight.style.width = `${rect.width + 20}px`;
                spotlight.style.height = `${rect.height + 20}px`;
                spotlight.style.display = 'block';
                spotlight.classList.add('pulse');
                
                // Position tooltip
                let tooltipTop, tooltipLeft;
                const tooltipWidth = 320;
                
                if (steps[step].position === 'bottom') {
                    tooltipTop = rect.bottom + 20;
                    tooltipLeft = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                } else if (steps[step].position === 'top') {
                    tooltipTop = rect.top - 200;
                    tooltipLeft = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                }
                
                // Keep tooltip within viewport
                tooltipLeft = Math.max(10, Math.min(tooltipLeft, window.innerWidth - tooltipWidth - 10));
                tooltipTop = Math.max(10, tooltipTop);
                
                tooltip.style.left = `${tooltipLeft}px`;
                tooltip.style.top = `${tooltipTop}px`;
            }
        } else {
            // Center tooltip for intro/outro
            spotlight.style.display = 'none';
            tooltip.style.left = '50%';
            tooltip.style.top = '50%';
            tooltip.style.transform = 'translate(-50%, -50%)';
        }
        
        // Show tooltip with animation
        setTimeout(() => {
            tooltip.classList.add('active');
        }, 100);
    }
    
    function nextStep() {
        tooltip.classList.remove('active');
        
        setTimeout(() => {
            currentStep++;
            if (currentStep >= steps.length) {
                endWalkthrough();
            } else {
                // Reset transform for positioned tooltips
                if (steps[currentStep].element) {
                    tooltip.style.transform = 'translateY(0)';
                }
                showStep(currentStep);
            }
        }, 300);
    }
    
    function endWalkthrough() {
        localStorage.setItem('walkthrough_completed', 'true');
        overlay.classList.remove('active');
        spotlight.style.display = 'none';
        tooltip.classList.remove('active');
        
        setTimeout(() => {
            overlay.style.display = 'none';
            tooltip.style.display = 'none';
        }, 300);
    }
    
    // Event listeners
    nextBtn.addEventListener('click', nextStep);
    skipBtn.addEventListener('click', endWalkthrough);
    
    // Start walkthrough after a short delay
    setTimeout(() => {
        overlay.style.display = 'block';
        tooltip.style.display = 'block';
        setTimeout(() => {
            overlay.classList.add('active');
            showStep(0);
        }, 100);
    }, 500);
}
</script>

{%endblock content%}