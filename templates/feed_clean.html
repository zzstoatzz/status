{% extends "base.html" %}

{% block content %}
<div id="root">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="feed-title-wrapper">
                <h1 id="feed-title">global feed</h1>
                {% if let Some(p) = &profile %}
                <label class="feed-toggle" for="feed-toggle-input">
                    <input type="checkbox" id="feed-toggle-input" />
                    <span class="toggle-slider"></span>
                </label>
                {% endif %}
            </div>
            <div class="header-actions">
                <a href="/" class="nav-button" aria-label="Your status" title="Your status">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </a>
                {% if let Some(p) = &profile %}
                <button class="settings-toggle" id="settings-toggle" aria-label="Settings">
                    <img src="https://api.iconify.design/lucide:settings.svg" width="20" height="20" alt="Settings" class="settings-icon">
                </button>
                {% endif %}
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
                <span class="theme-indicator" id="theme-indicator"></span>
            </button>
            </div>
        </header>

        {% if is_admin %}
        <!-- Admin Upload (fixed top-left) -->
        <div class="admin-panel" id="admin-panel">
            <button class="admin-toggle" id="admin-toggle" title="admin tools" aria-label="admin tools">⚙️</button>
            <div class="admin-content" id="admin-content" style="display:none;">
                <div class="admin-section">
                    <div class="admin-title">upload emoji</div>
                    <form id="emoji-upload-form">
                        <input type="text" id="emoji-name" placeholder="name (optional)" maxlength="40" />
                        <input type="file" id="emoji-file" accept="image/png,image/gif" required />
                        <button type="submit">upload</button>
                    </form>
                    <div class="admin-msg" id="admin-msg" aria-live="polite"></div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Simple Settings (logged in users only) -->
        {% if let Some(p) = &profile %}
        <div class="simple-settings hidden" id="simple-settings">
            <div class="settings-row">
                <label>font</label>
                <div class="button-group">
                    <button class="font-btn active" data-font="system">system</button>
                    <button class="font-btn" data-font="mono">mono</button>
                    <button class="font-btn" data-font="serif">serif</button>
                    <button class="font-btn" data-font="comic">comic</button>
                </div>
            </div>
            <div class="settings-row">
                <label>accent</label>
                <input type="color" id="accent-color" value="#1DA1F2">
                <div class="preset-colors">
                    <button class="color-preset" data-color="#1DA1F2" style="background: #1DA1F2"></button>
                    <button class="color-preset" data-color="#FF6B6B" style="background: #FF6B6B"></button>
                    <button class="color-preset" data-color="#4ECDC4" style="background: #4ECDC4"></button>
                    <button class="color-preset" data-color="#FFEAA7" style="background: #FFEAA7"></button>
                    <button class="color-preset" data-color="#A29BFE" style="background: #A29BFE"></button>
                    <button class="color-preset" data-color="#FD79A8" style="background: #FD79A8"></button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Session Info -->
        {% if let Some(p) = &profile %}
        <div class="session-card">
            <div class="session-info">
                <span>logged in as <strong>{% if let Some(name) = &p.display_name %}{% if !name.is_empty() %}{{ name }}{% else %}{% if let Some(h) = &p.handle %}{{ h }}{% else %}{{ p.did }}{% endif %}{% endif %}{% else %}{% if let Some(h) = &p.handle %}{{ h }}{% else %}{{ p.did }}{% endif %}{% endif %}</strong></span>
                <div class="session-actions">
                    <a href="/" class="button button-primary">your status</a>
                    <form action="/logout" method="get" style="display: inline;">
                        <button type="submit" class="button button-secondary">log out</button>
                    </form>
                </div>
            </div>
        </div>
        {% else %}
        <div class="session-card">
            <div class="session-info">
                <span>viewing public feed</span>
                <a href="/login" class="button button-primary">log in to set status</a>
            </div>
        </div>
        {% endif %}

        <!-- Feed -->
        <div class="feed-container">
            <div class="feed-header-with-indicator">
                <h2>recent updates</h2>
                {% if dev_mode %}
                <div class="dev-indicator" title="dev mode: showing dummy data mixed with real posts">dev</div>
                {% endif %}
            </div>
            
            <div class="status-list">
            {% if !statuses.is_empty() %}
                {% for status in statuses %}
                <div class="status-item" data-did="{{ status.author_did }}">
                    <span class="status-emoji">
                        {% if status.status.starts_with("custom:") %}
                            {% let emoji_name = status.status.strip_prefix("custom:").unwrap() %}
                            <img src="/emojis/{{emoji_name}}.png" alt="{{emoji_name}}" title="{{emoji_name}}" class="custom-emoji-display"
                                 onerror="this.onerror=null; this.src='/emojis/{{emoji_name}}.gif';">
                        {% else %}
                            <span title="{{status.status}}">{{status.status}}</span>
                        {% endif %}
                    </span>
                    <div class="status-content">
                        <div class="status-main">
                            <a class="status-author" href="/@{{status.author_display_name()}}">@{{status.author_display_name()}}</a>
                            {% if status.text.is_some() %}
                            <span class="status-text">{{ status.text.as_ref().unwrap() }}</span>
                            {% endif %}
                        </div>
                        <div class="status-meta">
                            <span class="local-time" data-timestamp="{{ status.started_at.to_rfc3339() }}" data-format="relative"></span>
                            {% if status.expires_at.is_some() %}
                                {% if !status.is_expired() %}
                                • <span class="local-time" data-timestamp="{{ status.expires_at.as_ref().unwrap().to_rfc3339() }}" data-prefix="expires"></span>
                                {% else %}
                                • expired
                                {% endif %}
                            {% endif %}
                            {% if is_admin %}
                            • <button class="hide-button" data-uri="{{ status.uri }}" style="color: var(--text-tertiary); background: none; border: none; cursor: pointer; text-decoration: underline;">hide</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- empty at render; JS will populate via /api/feed -->
            {% endif %}
            </div>
            
            <!-- Loading indicator -->
            <div id="loading-indicator" style="display: none; text-align: center; padding: 2rem;">
                <span style="color: var(--text-tertiary);">Loading more...</span>
            </div>
            
            <!-- End of feed indicator -->
            <div id="end-of-feed" style="display: none; text-align: center; padding: 2rem;">
                <span style="color: var(--text-tertiary);">you've reached the beginning of time ✨</span>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="/" class="nav-button-bottom">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>your status</span>
            </a>
        </nav>
    </div>
</div>

<script>
// Initialize feed page with template data
document.addEventListener('DOMContentLoaded', function() {
    // Initialize theme
    if (typeof ThemeManager !== 'undefined') {
        ThemeManager.init();
    }
    
    // Initialize admin panel
    if (typeof AdminManager !== 'undefined') {
        AdminManager.init();
    }
    
    // Initialize feed functionality
    if (typeof FeedManager !== 'undefined') {
        const initialOffset = {% if !statuses.is_empty() %}{{ statuses.len() }}{% else %}0{% endif %};
        const currentUserDid = {% if let Some(p) = &profile %}"{{ p.did }}"{% else %}null{% endif %};
        FeedManager.init(initialOffset, currentUserDid);
    }
    
    // Add theme toggle event listener
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle && typeof ThemeManager !== 'undefined') {
        themeToggle.addEventListener('click', ThemeManager.toggle);
    }
});
</script>
{%endblock content%}